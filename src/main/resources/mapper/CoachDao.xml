<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.dgut.jsf.mapper.CoachDao">
    <!--查询所有在线的教练  联合查询-->
    <select id="findAllCoachUp" resultMap="findCoachUpByCoach_nameResult">
		select coa.*,ch.*
		from t_coach coa,t_classhour ch
		where coa.ch_id=ch.ch_id
		order by ch_price
	</select>
    <!--根据教练名称，性别，特长和课时类型的价格查询所有在线的教练   多对多-->
    <select id="findCoachUpByCoach_name" resultMap="findCoachUpByCoach_nameResult">
        select coa.*,ch.*
		from t_coach coa,t_classhour ch
		where coa.ch_id=ch.ch_id
		 and ${arg0} like '%${arg1}%'
		order by ch_price
    </select>
    <resultMap id="findCoachUpByCoach_nameResult" type="Coach">
        <id property="coach_id" column="coach_id"></id>
        <result column="coach_name" property="coach_name"  />
        <result column="coach_sex" property="coach_sex" />
        <result column="coach_mobile" property="coach_mobile" />
        <result column="coach_wechat" property="coach_wechat" />
        <result column="coach_qq" property="coach_qq"  />
        <result column="coach_expert" property="coach_expert"  />
        <result column="coach_resume" property="coach_resume" />
        <association property="classHour" javaType="ClassHour">
            <id property="ch_id" column="ch_id"></id>
            <result column="ch_type" property="ch_type"  />
            <result property="ch_content" column="ch_content"></result>
            <result property="ch_price" column="ch_price"></result>
        </association>
    </resultMap>
    <!--根据会员id查询会员的课时类型-->
    <select id="findAllMchByMemberId" parameterType="int" resultType="MemberClassHour">
        select *
        from t_memberclasshour
        where member_id=#{member_id}
    </select>
    <!--查询出会员的课时类型的剩余课时-->
    <select id="findMchRemainingQuantity"  resultType="MemberClassHour">
		select * from  t_memberclasshour where member_id=#{arg0} and ch_id=#{arg1}
	</select>
    <!--预约成功，课时减一-->
    <update id="reduceMchRemainingQuantity" >
	update t_memberclasshour set mch_remainingQuantity=mch_remainingQuantity-1 where member_id=#{arg0} and ch_id=#{arg1}
	</update>
    <!--预约成功，课时删除-->
    <delete id="delMemberClassHour">
        delete from t_memberclasshour where member_id=#{arg0} and ch_id=#{arg1}
    </delete>
    <!--插入会员预约教练信息-->
    <insert id="CoachAppointWeb" parameterType="CoachAppoint">
insert into t_coachappoint(member_id,coach_id,ch_id,ca_startTime,ca_endTime)
	values(#{member_id},#{coach_id},#{classHour.ch_id},#{ca_startTime},#{ca_endTime})
</insert>
    <!--根据教练的课时类型查询出预约的最小时间段-->
    <select id="findMinTimeByCoachIdAndChId" resultType="CoachAppoint">
         SELECT * FROM t_coachappoint a WHERE a.coach_id=#{arg0} and a.ch_id=#{arg1} and
a.ca_startTime
in (select min(b.ca_startTime)
from t_coachappoint b
where  b.coach_id=#{arg0} and b.ch_id=#{arg1} and DATEDIFF(ca_startTime,#{arg2})=+#{arg3}
)
    </select>
    <!--根据教练的课时类型查询出预约的最大时间段-->
    <select id="findMaxTimeByCoachIdAndChId" resultType="CoachAppoint">
         SELECT * FROM t_coachappoint a WHERE a.coach_id=#{arg0} and a.ch_id=#{arg1} and
a.ca_endTime
in (select max(b.ca_endTime)
from t_coachappoint b
where  b.coach_id=#{arg0} and b.ch_id=#{arg1} and DATEDIFF(ca_endTime,#{arg2})=+#{arg3}
)
    </select>
    <!--发现该时间段是否有预约-->
    <select id="findendTime" parameterType="String" resultType="CoachAppoint">
        select *
        from t_coachappoint
        where ca_endTime=#{ca_startTime} or ca_startTime=#{ca_startTime}
    </select>
    <!--查出会员账号-->
    <select id="findUserByMmeberId" resultType="User">
        select user_id
        from t_member
        where member_id=#{member_id}
    </select>
    <!--根据账号查询出会员的账户-->
    <select id="getPayInfoByCID" resultType="Fee">
        select * from t_fee where user_id=#{user_id}
    </select>

    <select id="findCoachAppointByTime" resultType="CoachAppoint">
        select *
        from t_coachappoint
        where ca_startTime=#{arg0} and member_id=#{arg1}
    </select>
</mapper>
