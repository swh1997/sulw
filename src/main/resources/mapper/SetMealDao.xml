<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.dgut.jsf.mapper.SetMealDao">
    <!--根据会员id查找该会员拥有的上线的课时类型  多对多 -->
    <select id="findClassHourUpByUserId" parameterType="String" resultMap="findClassHourUpByUserIdResult">
            select m.*,ch.ch_id,ch_content,ch_price,mch_id,mch_remainingQuantity
            from t_member m,t_classhour ch,t_memberclasshour mch
            where mch_state=1 and mch.member_id=m.member_id and mch.ch_id=ch.ch_id
            and m.user_id=#{user_id}
       </select>
    <select id="findChByMemberId" parameterType="INTEGER"  resultType="INTEGER">
        select count(mch_id) from t_memberclasshour where member_id=#{member_id}
    </select>
    <resultMap id="findClassHourUpByUserIdResult" type="Member">
        <id property="member_id" column="member_id"></id>
        <result column="user_id" property="user.user_id" jdbcType="VARCHAR" />
        <result column="member_name" property="member_name" jdbcType="VARCHAR" />
        <result column="member_sex" property="member_sex" jdbcType="VARCHAR" />
        <result column="member_birthDate" property="member_birthDate" jdbcType="VARCHAR" />
        <result column="member_mobile" property="member_mobile" jdbcType="VARCHAR" />
        <result column="member_wechat" property="member_wechat" jdbcType="VARCHAR" />
        <result column="member_qq" property="member_qq" jdbcType="VARCHAR" />
        <result column="member_address" property="member_address" jdbcType="VARCHAR" />
        <result column="member_resume" property="member_resume" jdbcType="VARCHAR" />
        <result column="member_idcard" property="member_idcard" jdbcType="VARCHAR" />
        <result column="mc_id" property="memberCard.mc_id" jdbcType="INTEGER" />
        <result column="member_mcStart" property="member_mcStart" jdbcType="VARCHAR" />
        <result column="member_mcEnd" property="member_mcEnd" jdbcType="VARCHAR" />
        <collection property="classHourList" ofType="ClassHour">
            <id property="ch_id" column="ch_id"></id>
            <result column="ch_type" property="ch_type" jdbcType="VARCHAR" />
            <result property="ch_content" column="ch_content"></result>
            <result property="ch_price" column="ch_price"></result>
        </collection>
    </resultMap>
    <!--通过会员账号找会员信息-->
    <select id="findMNameByUserId" parameterType="String" resultMap="findMNameByUserIdResult">
		select * from t_member where user_id=#{user_id}
	</select>
    <resultMap id="findMNameByUserIdResult" type="Member">
        <id property="member_id" column="member_id"></id>
        <result column="user_id" property="user.user_id" jdbcType="VARCHAR" />
        <result column="member_name" property="member_name" jdbcType="VARCHAR" />
        <result column="member_sex" property="member_sex" jdbcType="VARCHAR" />
        <result column="member_birthDate" property="member_birthDate" jdbcType="VARCHAR" />
        <result column="member_mobile" property="member_mobile" jdbcType="VARCHAR" />
        <result column="member_wechat" property="member_wechat" jdbcType="VARCHAR" />
        <result column="member_qq" property="member_qq" jdbcType="VARCHAR" />
        <result column="member_address" property="member_address" jdbcType="VARCHAR" />
        <result column="member_resume" property="member_resume" jdbcType="VARCHAR" />
        <result column="member_idcard" property="member_idcard" jdbcType="VARCHAR" />
        <result column="mc_id" property="memberCard.mc_id" jdbcType="INTEGER" />
        <result column="member_mcStart" property="member_mcStart" jdbcType="VARCHAR" />
        <result column="member_mcEnd" property="member_mcEnd" jdbcType="VARCHAR" />
    </resultMap>
    <!--查询所有在线的活套餐  一对一和多对多-->
    <select id="findSetMealUp" resultMap="findSetMealUpResullt">
		select sm.*,ch.*,mc.*
		from t_setmeal sm,t_classhour ch,t_membercard mc,t_setmealclasshour smch
        where sm.mc_id=mc.mc_id and smch.sm_id=sm.sm_id and smch.ch_id=ch.ch_id
		order by sm_price
	</select>
    <resultMap id="findSetMealUpResullt" type="SetMeal">
        <id property="sm_id" column="sm_id"></id>
        <result property="sm_name" column="sm_name"></result>
        <result property="sm_price" column="sm_price"></result>
        <association property="memberCard" javaType="MemberCard">
            <id property="mc_id" column="mc_id"></id>
            <result property="mc_quantity" column="mc_quantity"></result>
            <result property="mc_content" column="mc_content"></result>
            <result property="mc_price" column="mc_price"></result>
        </association>
        <collection property="classHourList" ofType="ClassHour">
            <id property="ch_id" column="ch_id"></id>
            <result column="ch_type" property="ch_type"  />
            <result property="ch_content" column="ch_content"></result>
            <result property="ch_price" column="ch_price"></result>
        </collection>
    </resultMap>
    <!--根据id查询套餐  一对一多对多-->
    <select id="findSetMealById" resultMap="findSetMealUpResullt">
		select sm.*,ch.*,mc.*
		from t_setmeal sm,t_classhour ch,t_membercard mc,t_setmealclasshour smch
        where sm.mc_id=mc.mc_id and smch.sm_id=sm.sm_id and smch.ch_id=ch.ch_id and sm.sm_id=#{sm_id}
		order by sm_price
	</select>
    <!--没有会员卡时修改时间（插入）-->
    <update id="buySetMealTwoById" parameterType="Member">
        update t_member set mc_id=#{memberCard.mc_id},member_mcStart=#{member_mcStart},member_mcEnd=#{member_mcEnd}
        where member_id=#{member_id}
	</update>
    <!--有会员卡时修改时间（修改）-->
    <update id="buySetMealTwoByIdTwo" parameterType="member">
    update t_member set member_mcEnd=#{member_mcEnd},mc_id=#{memberCard.mc_id}
        where member_id=#{member_id}
</update>
    <!--根据id查询套餐课时-->
    <select id="findClassHourQuantityById" resultType="SetMealClassHour">
        select sm_id,ch_id,smch_quantity,smch_present
        from t_setmealclasshour
        where sm_id=#{sm_id}
          order by ch_id
    </select>
    <!--查询会员有无该课时，有多少。-->
    <select id="findMchById" resultType="MemberClassHour" >
        select mch_id
        from t_memberclasshour
        where member_id=#{arg1} and ch_id=#{arg0.ch_id}
    </select>
    <!--会员无该课时（插入）-->
    <insert id="buySetMealById">
        insert into
		t_memberclasshour(member_id,ch_id,mch_remainingQuantity)
		values(#{arg1},#{arg0.ch_id},#{arg0.smch_quantity}+#{arg0.smch_present})
	</insert>
    <!--查询会员有该课时（修改）。-->
    <update id="buySetMealByIdTwo">
   update t_memberclasshour set mch_remainingQuantity=mch_remainingQuantity+(#{arg0.smch_quantity}+#{arg0.smch_present})
		where member_id=#{arg1} and ch_id=#{arg0.ch_id}
</update>
    <!--根据账号查询出会员的账户-->
    <select id="getPayInfoByCID" resultMap="getPayInfoByCIDResult">
        select fee.*,sm.*
        from t_fee fee,t_setmeal sm
        where fee.sm_id=sm.sm_id and
        user_id=#{arg0} and fee_datetimet=#{arg1}
    </select>
    <resultMap id="getPayInfoByCIDResult" type="Fee">
        <id property="fee_id" column="sm_id"></id>
        <result property="fee_used" column="fee_used"></result>
        <result property="fee_datetimet" column="fee_datetimet"></result>
        <association property="setMeal" javaType="SetMeal">
        <id property="sm_id" column="sm_id"></id>
        <result property="sm_name" column="sm_name"></result>
        <result property="sm_price" column="sm_price"></result>
        </association>
    </resultMap>

    <insert id="insertFee" parameterType="Fee">
        insert into t_fee(user_id,fee_used,fee_datetimet,sm_id)
        values(#{arg0},#{arg1},#{arg2},#{arg3})
    </insert>

</mapper>
